name: Advanced CD Pipeline

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. ‡∏î‡πà‡∏≤‡∏ô‡∏ï‡∏£‡∏ß‡∏à: ‡∏ï‡∏£‡∏ß‡∏à‡πÑ‡∏ß‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå‡πÑ‡∏ü‡∏•‡πå Docker Compose
      - name: Verify Docker Compose File
        run: docker compose config

      # 2. ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô Discord: ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£ Deploy
      - name: Discord Notification (Starting)
        uses: rjstone/discord-webhook-notify@v1
        with:
          severity: info
          details: "üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏≤‡∏£ Deploy ‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå‡πÑ‡∏õ‡∏¢‡∏±‡∏á Server..."
          webhookUrl: ${{ secrets.DISCORD_WEBHOOK }}

      # 3. ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£ Deploy ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (SSH ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏•‡∏≤‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡πÅ‡∏•‡∏∞‡∏£‡∏±‡∏ô)
      - name: Deploy via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          PASSWORD: ${{ secrets.PASSWORD }}
          script: |
            cd ~/my-first-stack
            git pull origin main
            docker compose up -d --build

      # 4. ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô Discord: ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
      - name: Discord Notification (Success)
        if: success()
        uses: rjstone/discord-webhook-notify@v1
        with:
          severity: success
          details: "‚úÖ Deploy ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß! ‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô"
          webhookUrl: ${{ secrets.DISCORD_WEBHOOK }}

      # 5. ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô Discord: ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏û‡∏±‡∏á
      - name: Discord Notification (Failure)
        if: failure()
        uses: rjstone/discord-webhook-notify@v1
        with:
          severity: error
          details: "‚ùå ‡∏Å‡∏≤‡∏£ Deploy ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Log ‡∏ö‡∏ô GitHub"
          webhookUrl: ${{ secrets.DISCORD_WEBHOOK }}
